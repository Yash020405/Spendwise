name: CD Pipeline - Deploy to Kubernetes

# ============================================================
# CD PIPELINE TRIGGER
# Purpose: Deploy to Kubernetes on EC2
# ============================================================
on:
  workflow_run:
    workflows: ["CI Pipeline - Spendwise Backend"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/spendwise-server

jobs:
  # ============================================================
  # CD DEPLOYMENT JOB
  # ============================================================
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
    # ============================================================
    # STAGE 1: CHECKOUT
    # Purpose: Get deployment scripts and configs
    # ============================================================
    - name: Checkout source code
      uses: actions/checkout@v4

    # ============================================================
    # STAGE 2: CONFIGURE SSH
    # Purpose: Setup SSH key for EC2 access
    # Why: Secure deployment without storing keys in code
    # ============================================================
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

    # ============================================================
    # STAGE 3: DEPLOY TO KUBERNETES
    # Purpose: SSH to EC2 and update K8s deployment
    # Why: Rolling update with zero downtime
    # ============================================================
    - name: Deploy to Kubernetes
      run: |
        ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          echo "=== Starting Kubernetes Deployment ==="
          
          # Check Minikube status
          echo "Checking Minikube status..."
          minikube status || minikube start --driver=docker --force
          
          # Trigger rolling update (pulls latest image)
          echo "Rolling update deployment..."
          kubectl rollout restart deployment/spendwise-server -n spendwise
          
          # Wait for rollout to complete
          echo "Waiting for rollout to complete..."
          kubectl rollout status deployment/spendwise-server -n spendwise --timeout=180s
          
          # Show deployment status
          echo "=== Deployment Status ==="
          kubectl get pods -n spendwise
          kubectl get svc -n spendwise
          
          echo "=== Kubernetes Deployment Complete ==="
        EOF

    # ============================================================
    # STAGE 4: VERIFY DEPLOYMENT
    # Purpose: Confirm application is accessible
    # ============================================================
    - name: Verify Deployment
      run: |
        echo "Waiting for pods to stabilize..."
        sleep 20
        
        echo "Checking health endpoint..."
        curl -f http://${{ secrets.EC2_HOST }}:3000/api/health || exit 1
        
        echo "Deployment verified!"

    # ============================================================
    # STAGE 5: DAST - Dynamic Application Security Testing
    # Purpose: Scan running application for security issues
    # Why: Detects runtime vulnerabilities
    # ============================================================
    - name: OWASP ZAP DAST Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: http://${{ secrets.EC2_HOST }}:3000
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a -j'
      continue-on-error: true

    # ============================================================
    # STAGE 6: CD SUMMARY
    # Purpose: Generate deployment summary
    # ============================================================
    - name: CD Pipeline Summary
      run: |
        echo "## CD Pipeline - Kubernetes Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Checkout | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| Configure SSH | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| K8s Rolling Update | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| Verify Deployment | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| DAST Scan | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**App URL:** \`http://${{ secrets.EC2_HOST }}:3000\`" >> $GITHUB_STEP_SUMMARY
        echo "**Replicas:** 2" >> $GITHUB_STEP_SUMMARY
        echo "**Strategy:** Rolling Update (Zero Downtime)" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # ROLLBACK JOB
  # Purpose: Revert to previous version on failure
  # ============================================================
  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

    - name: Rollback Kubernetes deployment
      run: |
        ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          echo "Deployment failed, initiating rollback..."
          kubectl rollout undo deployment/spendwise-server -n spendwise
          kubectl rollout status deployment/spendwise-server -n spendwise --timeout=120s
          echo "Rollback complete!"
        EOF
