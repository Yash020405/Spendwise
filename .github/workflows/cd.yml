# CD Pipeline - Deploy to Kubernetes
name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/spendwise-server

jobs:
  # Stage 1: Deploy
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v4
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
      - name: Deploy to K8s
        run: |
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            echo "[1/4] Checking Minikube status..."
            minikube status || minikube start --driver=docker --force
            
            echo "[2/4] Rolling update..."
            kubectl rollout restart deployment/spendwise-server -n spendwise
            
            echo "[3/4] Waiting for rollout..."
            kubectl rollout status deployment/spendwise-server -n spendwise --timeout=180s
            
            echo "[4/4] Deployment status:"
            kubectl get pods -n spendwise
          EOF

  # Stage 2: Verify
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
      - run: sleep 20
      - name: Health Check
        run: |
          curl -f http://${{ secrets.EC2_HOST }}:3000/api/health || exit 1
          echo "Health check passed"

  # Stage 3: DAST
  dast-scan:
    name: DAST Security Scan
    runs-on: ubuntu-latest
    needs: [verify]
    steps:
      - uses: actions/checkout@v4
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
      - name: Run DAST
        run: |
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            echo "[1/5] Security headers..."
            curl -sI http://localhost:3000/api/health | head -10
            
            echo "[2/5] SQL injection test..."
            curl -s "http://localhost:3000/api/health?id=1'OR'1'='1" | head -c 100
            
            echo "[3/5] XSS test..."
            curl -s "http://localhost:3000/api/health?q=<script>alert(1)</script>" | head -c 100
            
            echo "[4/5] Error handling..."
            curl -s http://localhost:3000/api/nonexistent | head -c 100
            
            echo "[5/5] Sensitive data check..."
            curl -s http://localhost:3000/api/health | grep -qi "password\|secret" && echo "WARNING" || echo "OK"
          EOF

  # Stage 4: Rollback (on failure)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: failure()
    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
      - name: Rollback
        run: |
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            kubectl rollout undo deployment/spendwise-server -n spendwise
            kubectl rollout status deployment/spendwise-server -n spendwise --timeout=120s
          EOF
