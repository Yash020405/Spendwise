# CD Pipeline - Deploy to Kubernetes
name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/spendwise-server

jobs:
  # Stage 1: Deploy
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v4
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
      - name: Deploy to K8s
        run: |
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            echo "[1/4] Checking Minikube status..."
            minikube status || minikube start --driver=docker --force
            
            echo "[2/4] Rolling update..."
            kubectl rollout restart deployment/spendwise-server -n spendwise
            
            echo "[3/4] Waiting for rollout..."
            kubectl rollout status deployment/spendwise-server -n spendwise --timeout=180s
            
            echo "[4/4] Deployment status:"
            kubectl get pods -n spendwise
          EOF

  # Stage 2: Verify
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
      - run: sleep 20
      - name: Health Check
        run: |
          curl -f http://${{ secrets.EC2_HOST }}:3000/api/health || exit 1
          echo "Health check passed"

  # Stage 3: DAST - OWASP ZAP (Production-Grade)
  dast-scan:
    name: DAST Security Scan (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: [verify]
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      # Create ZAP rules configuration
      - name: Create ZAP Configuration
        run: |
          mkdir -p .zap
          # Rule configuration: WARN on all alerts (don't fail build)
          cat > .zap/rules.tsv << 'EOF'
          10010	WARN	(Cookie No HttpOnly Flag)
          10011	WARN	(Cookie Without Secure Flag)
          10015	WARN	(Incomplete or No Cache-control Header Set)
          10017	WARN	(Cross-Domain JavaScript Source File Inclusion)
          10019	WARN	(Content-Type Header Missing)
          10020	WARN	(Anti-clickjacking Header)
          10021	WARN	(X-Content-Type-Options Header Missing)
          10036	WARN	(Server Leaks Version Information)
          10038	WARN	(Content Security Policy Header Not Set)
          10098	WARN	(Cross-Domain Misconfiguration)
          10202	WARN	(Absence of Anti-CSRF Tokens)
          40012	WARN	(Cross Site Scripting - Reflected)
          40014	WARN	(Cross Site Scripting - Persistent)
          40016	WARN	(Cross Site Scripting - Script in Attribute)
          40018	WARN	(SQL Injection)
          90033	WARN	(Loosely Scoped Cookie)
          EOF
      
      # Run OWASP ZAP Full Scan
      - name: Run OWASP ZAP Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://${{ secrets.EC2_HOST }}:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
        continue-on-error: true
      
      # Upload SARIF to GitHub Security Tab
      - name: Upload ZAP SARIF Report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'report_sarif.json'
        continue-on-error: true
        if: always()

  # Stage 4: Rollback (on failure)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: failure()
    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
      - name: Rollback
        run: |
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            kubectl rollout undo deployment/spendwise-server -n spendwise
            kubectl rollout status deployment/spendwise-server -n spendwise --timeout=120s
          EOF
